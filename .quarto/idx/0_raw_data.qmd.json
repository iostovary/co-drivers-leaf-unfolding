{"title":"Raw data","markdown":{"yaml":{"output":"html_document","editor_options":{"chunk_output_type":"inline"},"execute":{"freeze":false}},"headingText":"Raw data","containsRefs":false,"markdown":"\n\n\n```{r source}\nlocation <- paste0(getwd())\nsource(paste0(\"../00_helpers/setup.R\")) #common libraries and custom functions\nsource(paste0(\"../00_helpers/species_and_phases.R\"))\n\npackage_fun(lib_standard, \"standard\")\n\ncit <- citation()\nbibtex_entry <- toBibtex(cit)\nbibtex_entry[[1]] <- paste0(\"@software{R_core_team,\")\nwriteLines(unlist(bibtex_entry), paste0(location, \"/lib_citations_R.bib\"))\n\nraw_station_meteoswiss <- read.csv2(paste0(\"C:/Users/iostovary/Documents/Data/meteoswiss/stations/ch.meteoschweiz.messnetz-phaenologie_en_220505.csv\", dec = \".\"))\n```\n\n# Available sites\n\n```{r format-station, include=FALSE}\nstation_meteoswiss <- raw_station_meteoswiss %>% \n  rename (nat_abbr = 'Abbr.',\n          stat_LV95_y = \"CoordinatesN\",\n          stat_LV95_x = \"CoordinatesE\",\n          stat_WGS_y = \"Longitude\",\n          stat_WGS_x = \"Latitude\",\n          stat_elevation = \"Station.height.m..a..sea.level\") %>% \n  slice_head(n=-3) %>% \n  mutate(siteId = 1:178,\n         stat_WGS_x = as.numeric(stat_WGS_x),\n         stat_WGS_y = as.numeric(stat_WGS_y)) %>%\n  dplyr::select (-WIGOS.ID, -Station.type, -Data.Owner, -Canton, -Measurements, -Link)\n\nsaveRDS(station_meteoswiss, paste0(path_own_data, \"/station_meteoswiss.rds\"))\n```\n\n## Tree sample data\n\n```{r read-sample-data}\n#SAMPLE GEODATA\nraw_sample_coord <- read_csv(paste0(path_own_data, \"/coordinates/spn_coordinates_garminoregon750t_230703.csv\"))\nraw_sample_coord_corrected <- read_xlsx(paste0(path_own_data, \"/coordinates/spn_coordinates_corrected_230703.xlsx\"))\n\n#TREE INFO\nraw_sample <- read_excel(\"C:/Users/iostovary/OneDrive - ETH Zurich/zivi_soil/sampling_data_230815.xlsm\",\n                         #sampling_data_230203_nachbearbeitung_IO.xlsm\n                         sheet=\"spn_trees\")\n\n#COMPETITION INFO\nraw_sample_comp <- read_excel(\"C:/Users/iostovary/OneDrive - ETH Zurich/zivi_soil/sampling_data_230815.xlsm\",\n                         #sampling_data_230203_nachbearbeitung_IO.xlsm\n                         sheet=\"spn_competition\")\n  \n#SOIL INFO\nraw_sample_soil <- read_excel(\"C:/Users/iostovary/OneDrive - ETH Zurich/zivi_soil/sampling_data_230815.xlsm\",\n                         #sampling_data_230203_nachbearbeitung_IO.xlsm\n                         sheet=\"spn_soil_cores\")\n```\n\n```{r format-sample-data}\nsample_coord <- raw_sample_coord %>%\n  slice_head(n=-12) %>%\n  slice_tail(n=-14) %>%\n  separate(col = \"metadata\", into = c(\"ID\",\"lat\",\"lon\",\"ele\",\"time\",\"magvar\",\"geoidheight\",\"name\",\"cmt\",\"desc\",\"src\",\"sym\",\"type\",\"fix\",\"sat\",\"hdop\",\"vdop\",\"pdop\",\"ageofdgpsdata\",\"dgpsid\",\"Proximity\",\"Temperature\",\"Depth\",\"DisplayMode\",\"Samples\",\"Expiration\",\"CreationTime\"), sep=\",\") %>% \n  row_to_names(1) %>% \n  dplyr::select(lat, lon, ele, time, name, Samples) %>% \n  mutate(time = as_date(time),\n         Samples = as.numeric(Samples),\n         ele = as.numeric(ele),\n         name = str_remove_all(name, \"[:punct:]\"),\n         name = as.numeric(name),\n         lat = as.numeric(lat),\n         lon = as.numeric(lon)) %>%\n  rename(TREE_WGS_x=lat,\n         TREE_WGS_y=lon,\n         TREE_ELEVATION=ele,\n         COORDINATE_ID=name,\n         COORDINATE_TIME=time,\n         COORDINATE_SAMPLES=Samples)\n\nsample_coord_corrected <- raw_sample_coord_corrected %>% \n  separate(TREE_WGS_corrected, into = c(\"TREE_WGS_x_corrected\",\"TREE_WGS_y_corrected\"), sep = \",\") %>% \n  filter(Comment != \"old SPN tree\" | is.na(Comment)) %>% \n  mutate(TREE_WGS_x_corrected = as.numeric(TREE_WGS_x_corrected),\n         TREE_WGS_y_corrected = as.numeric(TREE_WGS_y_corrected),\n         Comment = as.character(Comment))\n\n#TREE INFO\nsample <- raw_sample %>%\n  # format data\n  mutate(DBH_SUM_TREE = sapply(strsplit(raw_sample$DBH_single, '/'), function(x) sum(as.numeric(x)))) %>% \n  filter(SPECIES != \"SA\", is.na(EXCLUDE)) %>%\n  rename(SPECIES_TREE = SPECIES) %>% \n  unite(SAMPLE_CODE_LONG, c(DATE, METEO_ID, SPECIES_TREE), sep= \"_\", remove = FALSE) %>%\n  mutate(SAMPLE_CODE_LONG = stringr::str_replace_all(SAMPLE_CODE_LONG, \"[-]\", \"_\")) %>% \n  unite(SAMPLE_CODE, c(METEO_ID, SPECIES_TREE), sep=\"_\", remove=FALSE) %>% \n  separate(CROWN_EXPOSITION_ASPECT1, c(\"CROWN_EXPOSITION_ASPECT1_TRUE\",\"CROWN_EXPOSITION_ASPECT1_MAG\"), sep =\"/\") %>% \n  separate(CROWN_EXPOSITION_ASPECT2, c(\"CROWN_EXPOSITION_ASPECT2_TRUE\",\"CROWN_EXPOSITION_ASPECT2_MAG\"), sep=\"/\") %>%\n  separate(SLOPE_ASPECT1, c(\"SLOPE_ASPECT1_TRUE\",\"SLOPE_ASPECT1_MAG\"), sep =\"/\") %>%\n  separate(SLOPE_ASPECT2, c(\"SLOPE_ASPECT2_TRUE\",\"SLOPE_ASPECT2_MAG\"), sep =\"/\") %>%\n  mutate(COORDINATE_ID = as.numeric(COORDINATE_ID),\n         CROWN_EXPOSITION_ASPECT1_TRUE = as.numeric(CROWN_EXPOSITION_ASPECT1_TRUE), #it is safer to mutate instead of convert during the separation\n         CROWN_EXPOSITION_ASPECT2_TRUE = as.numeric(CROWN_EXPOSITION_ASPECT2_TRUE),\n         CROWN_EXPOSITION_ASPECT1_MAG = as.numeric(CROWN_EXPOSITION_ASPECT1_MAG),\n         CROWN_EXPOSITION_ASPECT2_MAG = as.numeric(CROWN_EXPOSITION_ASPECT2_MAG),\n         SLOPE_ASPECT1_TRUE = as.numeric(SLOPE_ASPECT1_TRUE),\n         SLOPE_ASPECT2_TRUE = as.numeric(SLOPE_ASPECT2_TRUE),\n         SLOPE_ASPECT1_MAG = as.numeric(SLOPE_ASPECT1_MAG),\n         SLOPE_ASPECT2_MAG = as.numeric(SLOPE_ASPECT2_MAG),\n         SLOPE_INCLINATION = as.integer(SLOPE_INCLINATION),\n         SLOPE_INCLINATION2 = as.integer(SLOPE_INCLINATION2),\n         HOLE_DEPTH_1 = as.numeric(HOLE_DEPTH_1),\n         HOLE_DEPTH_2 = as.numeric(HOLE_DEPTH_2),\n         HOLE_DEPTH_3 = as.numeric(HOLE_DEPTH_3),\n         CORE_DEPTH_1 = as.numeric(CORE_DEPTH_1),\n         CORE_DEPTH_2 = as.numeric(CORE_DEPTH_2),\n         CORE_DEPTH_3 = as.numeric(CORE_DEPTH_3),\n         TREE_HEIGHT = as.numeric(TREE_HEIGHT),\n         DBH_single = as.numeric(DBH_single),\n         EDGE_DIST_IMPUTED = case_when(EDGE_DIST == \"x\" ~\"imputed\",\n                                                  EDGE_DIST == \"∞\" ~\"imputed\",\n                                                  is.na(EDGE_DIST) ~\"imputed\",\n                                                  TRUE ~\"original\"),\n         EDGE_DIST = as.numeric(case_when(EDGE_DIST == \"x\" ~\"-5\",\n                                       EDGE_DIST == \"∞\" ~\"50\",\n                                       is.na(EDGE_DIST) ~\"-5\",\n                                       TRUE ~EDGE_DIST)),\n         RELIEF = case_when(RELIEF == \"1\"~ \"flat\",\n                            RELIEF == \"2\"~ \"crest or upper slope\",\n                            RELIEF == \"3\"~ \"midslope\",\n                            RELIEF == \"4\"~ \"slope base or trough\",\n                            RELIEF == \"5\"~ \"not determined\",\n                            TRUE ~ as.character(RELIEF))) %>% \n  mutate(across(c(RELIEF, KRAFT_CLASS), as.factor)) %>%\n  filter(DATE != \"Kontrolle\", !is.na(COORDINATE_ID)) %>% # TO DO: remove data check line from original data\n  \n  # impute missing or wrong measurements at individual sites\n  mutate(DBH_SUM_TREE = case_when(SAMPLE_CODE_LONG == \"20_04_23_CEC_TC\" ~ 29,\n         TRUE ~ DBH_SUM_TREE)) %>%\n  # correct slope inclination # TO DO: Move this to topography\n  mutate(SLOPE_INCLINATION = case_when(SAMPLE_CODE==\"LOL_LD\" ~ SLOPE_INCLINATION2,\n                                       SAMPLE_CODE==\"GON_TC\" ~ SLOPE_INCLINATION2,\n                                       TRUE ~ SLOPE_INCLINATION)) %>%\n  # correct slope aspect # TO DO: Move this to topography\n  mutate(SLOPE_ASPECT1_MAG = case_when(SAMPLE_CODE ==\"LCN_FS\" ~ 110,\n                                       TRUE ~SLOPE_ASPECT1_MAG)) %>% \n  # transform slope to degrees and calculate slope index # TO DO: Move this to topography\n  mutate(SLOPE_INCLINATION_DEG = atan(SLOPE_INCLINATION/100)*(180/pi),\n         SLOPE_INCLINATION_INDEX = 1-((SLOPE_INCLINATION_DEG)/90)) %>% # TO DO: Move this to topography\n  # temporarily correct HOLE_DEPTH as long as it's a proxy for water capacity\n  rowwise() %>%\n  mutate(HOLE_DEPTH_MAX = pmax(HOLE_DEPTH_1, HOLE_DEPTH_2, HOLE_DEPTH_3, na.rm=TRUE))\n\n#COMPETITION INFO\nsample_comp <- raw_sample_comp %>%\n  rename(SAMPLE_CODE_LONG = SAMPLE_CODE) %>% \n  mutate(SPECIES = case_when(SPECIES == \"LD\" ~ \"Larix decidua\",\n                             SPECIES == \"PA\" ~ \"Picea abies\",\n                             SPECIES == \"TC\" ~ \"Tilia cordata\",\n                             SPECIES == \"FS\" ~ \"Fagus sylvatica\",\n                             SPECIES == \"PV\" ~ \"Prunus avium\",\n                             SPECIES == \"RP\" ~ \"Robinia pseudoacacia\",\n                             TRUE ~ as.character(SPECIES)),\n         SAMPLE_CODE_LONG = stringr::str_replace_all(SAMPLE_CODE_LONG, \"[-]\", \"_\"),\n         SAMPLE_CODE = str_sub(SAMPLE_CODE_LONG, 10),\n         DBH_SUM_COMP = sapply(strsplit(raw_sample_comp$DBH_single, '/'), function(x) sum(as.numeric(x))),\n         DISTANCE = as.numeric(DISTANCE),\n         HEIGHT = as.numeric(HEIGHT)) %>% \n  filter(SPECIES != \"Corylus avellana\") %>%\n  rename(SPECIES_COMP = SPECIES) %>%\n  right_join(sample %>% #right join because trees without competition should be added as well\n               dplyr::select(SAMPLE_CODE_LONG, METEO_ID, SPECIES_TREE, LAND_USE, KRAFT_CLASS, SOCIAL_SITUATION, CROWN_EXPOSITION_CLASS, TREE_HEIGHT,  DBH_SUM_TREE) %>%\n               filter(SAMPLE_CODE_LONG != \"Kontrolle-x-x\"),\n             by = \"SAMPLE_CODE_LONG\") %>% \n  mutate(RELATIVE_CROWN_DISTANCE=as.numeric(case_when(is.na(RELATIVE_CROWN_DISTANCE) ~\"7\",\n                                                      RELATIVE_CROWN_DISTANCE==\"x\" ~\"6\",\n                                                      TRUE~ as.character(RELATIVE_CROWN_DISTANCE))))\n\n#SOIL INFO\nsample_soil <- raw_sample_soil %>%\n  mutate(SAMPLE_CODE_LONG = stringr::str_replace_all(SAMPLE_CODE, \"[-]\", \"_\"),\n         SAMPLE_CODE = str_sub(SAMPLE_CODE_LONG, 10),\n         SAMPLE_ID = case_when(DEPTH != \"extra\" ~ paste0(SAMPLE_CODE, sep=\"_\", DEPTH),\n                               DEPTH == \"extra\" ~ paste0(SAMPLE_CODE, sep=\"_\", DEPTH_EXTRA),\n                               TRUE ~ \"other\"),\n         DEPTH_ASSIGNED = case_when(is.na(DEPTH_ASSIGNED) ~ DEPTH,\n                                    TRUE ~ DEPTH_ASSIGNED),\n         POOLED_SAMPLE = POOLED_SAMPLE %>%\n           str_replace(\".{1,9}\", \"\") %>%\n           str_replace_all(\"-\", \"_\")) %>% \n  filter(!SAMPLE_CODE_LONG %like% \"SA\", !SAMPLE_CODE_LONG %like% \"RP\") %>%\n  bind_rows(filter(., !is.na(POOLED_SAMPLE)) %>%\n              mutate(SAMPLE_CODE = POOLED_SAMPLE,\n                     POOLED_SAMPLE = paste0(POOLED_SAMPLE, \"_COPY\")))\n\n#SAMPLE DATA\nsample_data <- sample %>% \n  left_join(sample_coord, by = \"COORDINATE_ID\") %>%\n  left_join(sample_coord_corrected %>% select(METEO_ID, SPECIES_TREE, TREE_WGS_y_corrected, TREE_WGS_x_corrected), by = c(\"METEO_ID\", \"SPECIES_TREE\")) %>%\n  left_join(station_meteoswiss %>% select(nat_abbr, siteId), by=c(\"METEO_ID\"=\"nat_abbr\"))\n```\n\n```{r save-output}\nsaveRDS(sample_data %>% ungroup(), paste0(path_own_data, \"/sample_data.rds\"))\nsaveRDS(sample_comp %>% ungroup(), paste0(path_own_data, \"/sample_competition.rds\"))\n```\n\n```{r create-soil-labels}\nmeta <- read.xlsx(\"C:/Users/iostovary/OneDrive - ETH Zurich/zivi_soil/sampling_data_230815.xlsm\", sheet = \"spn_soil_cores\") %>%\n   mutate(SAMPLE_CODE = str_sub(stringr::str_replace_all(SAMPLE_CODE, \"[-]\", \"_\"), 10),\n          SOIL_SAMPLE_ID = case_when(DEPTH != \"extra\" ~ paste0(SAMPLE_CODE, sep=\"_\", CORE_NO, sep=\"_\", stringr::str_replace_all(DEPTH, \"[-]\", \"_\")),\n                                     DEPTH == \"extra\" ~ paste0(SAMPLE_CODE, sep=\"_\", CORE_NO, sep=\"_\", stringr::str_replace_all(DEPTH_EXTRA, \"[-]\", \"_\")),\n                                     TRUE ~ \"other\"),\n          DEPTH = case_when(DEPTH ==\"extra\" ~ DEPTH_EXTRA,\n                            TRUE ~ DEPTH),\n          DEPTH_LABEL = case_when(is.na(DEPTH_ASSIGNED) ~ DEPTH,\n                                     TRUE ~ DEPTH_ASSIGNED),\n          SAMPLE_CORE = paste0(SAMPLE_CODE, \"_\", CORE_NO)) %>%\n  separate(SAMPLE_CODE, into = c(\"METEO_ID\",\"SPECIES_SHORT\"), remove = FALSE) %>% \n  separate(DEPTH, into=c(\"DEPTH_FROM\", \"DEPTH_TO\"), sep=\"-\", remove=FALSE) %>%\n  mutate(DEPTH_FROM = as.numeric(DEPTH_FROM),\n         DEPTH_TO = as.numeric(DEPTH_TO)) %>%\n  mutate(DEPTH_FROM = case_when(SOIL_SAMPLE_ID == \"LIN_FS_1_999\" ~ 5,\n                                TRUE ~ DEPTH_FROM),\n         DEPTH_TO = case_when(SOIL_SAMPLE_ID == \"LIN_FS_1_999\" ~ 10,\n                              TRUE ~ DEPTH_TO)) %>%\n  select(SOIL_SAMPLE_ID, SAMPLE_CODE, METEO_ID, SPECIES_SHORT, DEPTH_LABEL, DEPTH_FROM, DEPTH_TO, SAMPLE_CORE) %>%\n  unique()\n\nsaveRDS(meta %>% ungroup(), paste0(path_own_data, \"/soil_lab/soil_labels.rds\"))\n```\n\n\n## Climate\n\n### Data extraction\n\nMinimum, maximum and mean temperature as well as precipitation were\nextracted for each individual tree from 1970 to 2023 from the DAYMET\nnetCDF files \\[citation missing\\].\n\n```{r}\nsample_data <- readRDS(paste0(path_own_data, \"/sample_data.rds\"))\n```\n\n```{r}\nlibrary(terra)\ntree_coordinate_individual <- sample_data %>% filter(SPECIES_TREE %in% species_list) %>% \n  dplyr::select(SAMPLE_CODE, TREE_WGS_x_corrected, TREE_WGS_y_corrected) %>%\n  unique() %>%\n  mutate(TREE_WGS_x_corrected=as.numeric(TREE_WGS_x_corrected),\n         TREE_WGS_y_corrected=as.numeric(TREE_WGS_y_corrected)) %>%\n  rename(X = TREE_WGS_x_corrected,\n         Y = TREE_WGS_y_corrected) %>%\n  ungroup() %>%\n  mutate(COORD_ID = row_number())\n\ntree_coordinate_WGS <- terra::vect(tree_coordinate_individual, geom=c(\"Y\", \"X\"),\n                        #crs=\"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs\",\n                        crs=\"EPSG:4326\", # WGS84\n                        keepgeom=TRUE)\n\ntree_coordinate_ <- terra::project(tree_coordinate_WGS,\"EPSG:2056\") # LV95\n\ntree_coordinate_LV95 <- terra::as.data.frame(tree_coordinate_, geom=\"XY\") %>%\n  rename(LV95_TREE_x = x,\n         LV95_TREE_y = y) %>%\n  dplyr::select(LV95_TREE_x, LV95_TREE_y, COORD_ID) %>%\n  mutate_all(as.integer)\n\nsaveRDS(tree_coordinate_individual, paste0(path_own_data, \"/tree_coordinate_individual.rds\"))\nwrite.table(tree_coordinate_LV95, paste0(path_own_data,\"/coord.list\"), row.names = FALSE, col.names = FALSE)\n\ntree_coordinate_center <- sample_data %>%\n  select(METEO_ID, TREE_WGS_x, TREE_WGS_y) %>%\n  mutate(TREE_WGS_x=as.numeric(TREE_WGS_x),\n         TREE_WGS_y=as.numeric(TREE_WGS_y)) %>%\n  group_by(METEO_ID) %>%\n  summarise(X = mean(TREE_WGS_x),\n            Y = mean(TREE_WGS_y)) %>%\n  mutate(COORD_ID = 1:n()) %>%\n  ungroup()\n\nsaveRDS(tree_coordinate_center, paste0(path_own_data, \"/tree_coordinate_center.rds\"))\n```\n","srcMarkdownNoYaml":"\n\n# Raw data\n\n```{r source}\nlocation <- paste0(getwd())\nsource(paste0(\"../00_helpers/setup.R\")) #common libraries and custom functions\nsource(paste0(\"../00_helpers/species_and_phases.R\"))\n\npackage_fun(lib_standard, \"standard\")\n\ncit <- citation()\nbibtex_entry <- toBibtex(cit)\nbibtex_entry[[1]] <- paste0(\"@software{R_core_team,\")\nwriteLines(unlist(bibtex_entry), paste0(location, \"/lib_citations_R.bib\"))\n\nraw_station_meteoswiss <- read.csv2(paste0(\"C:/Users/iostovary/Documents/Data/meteoswiss/stations/ch.meteoschweiz.messnetz-phaenologie_en_220505.csv\", dec = \".\"))\n```\n\n# Available sites\n\n```{r format-station, include=FALSE}\nstation_meteoswiss <- raw_station_meteoswiss %>% \n  rename (nat_abbr = 'Abbr.',\n          stat_LV95_y = \"CoordinatesN\",\n          stat_LV95_x = \"CoordinatesE\",\n          stat_WGS_y = \"Longitude\",\n          stat_WGS_x = \"Latitude\",\n          stat_elevation = \"Station.height.m..a..sea.level\") %>% \n  slice_head(n=-3) %>% \n  mutate(siteId = 1:178,\n         stat_WGS_x = as.numeric(stat_WGS_x),\n         stat_WGS_y = as.numeric(stat_WGS_y)) %>%\n  dplyr::select (-WIGOS.ID, -Station.type, -Data.Owner, -Canton, -Measurements, -Link)\n\nsaveRDS(station_meteoswiss, paste0(path_own_data, \"/station_meteoswiss.rds\"))\n```\n\n## Tree sample data\n\n```{r read-sample-data}\n#SAMPLE GEODATA\nraw_sample_coord <- read_csv(paste0(path_own_data, \"/coordinates/spn_coordinates_garminoregon750t_230703.csv\"))\nraw_sample_coord_corrected <- read_xlsx(paste0(path_own_data, \"/coordinates/spn_coordinates_corrected_230703.xlsx\"))\n\n#TREE INFO\nraw_sample <- read_excel(\"C:/Users/iostovary/OneDrive - ETH Zurich/zivi_soil/sampling_data_230815.xlsm\",\n                         #sampling_data_230203_nachbearbeitung_IO.xlsm\n                         sheet=\"spn_trees\")\n\n#COMPETITION INFO\nraw_sample_comp <- read_excel(\"C:/Users/iostovary/OneDrive - ETH Zurich/zivi_soil/sampling_data_230815.xlsm\",\n                         #sampling_data_230203_nachbearbeitung_IO.xlsm\n                         sheet=\"spn_competition\")\n  \n#SOIL INFO\nraw_sample_soil <- read_excel(\"C:/Users/iostovary/OneDrive - ETH Zurich/zivi_soil/sampling_data_230815.xlsm\",\n                         #sampling_data_230203_nachbearbeitung_IO.xlsm\n                         sheet=\"spn_soil_cores\")\n```\n\n```{r format-sample-data}\nsample_coord <- raw_sample_coord %>%\n  slice_head(n=-12) %>%\n  slice_tail(n=-14) %>%\n  separate(col = \"metadata\", into = c(\"ID\",\"lat\",\"lon\",\"ele\",\"time\",\"magvar\",\"geoidheight\",\"name\",\"cmt\",\"desc\",\"src\",\"sym\",\"type\",\"fix\",\"sat\",\"hdop\",\"vdop\",\"pdop\",\"ageofdgpsdata\",\"dgpsid\",\"Proximity\",\"Temperature\",\"Depth\",\"DisplayMode\",\"Samples\",\"Expiration\",\"CreationTime\"), sep=\",\") %>% \n  row_to_names(1) %>% \n  dplyr::select(lat, lon, ele, time, name, Samples) %>% \n  mutate(time = as_date(time),\n         Samples = as.numeric(Samples),\n         ele = as.numeric(ele),\n         name = str_remove_all(name, \"[:punct:]\"),\n         name = as.numeric(name),\n         lat = as.numeric(lat),\n         lon = as.numeric(lon)) %>%\n  rename(TREE_WGS_x=lat,\n         TREE_WGS_y=lon,\n         TREE_ELEVATION=ele,\n         COORDINATE_ID=name,\n         COORDINATE_TIME=time,\n         COORDINATE_SAMPLES=Samples)\n\nsample_coord_corrected <- raw_sample_coord_corrected %>% \n  separate(TREE_WGS_corrected, into = c(\"TREE_WGS_x_corrected\",\"TREE_WGS_y_corrected\"), sep = \",\") %>% \n  filter(Comment != \"old SPN tree\" | is.na(Comment)) %>% \n  mutate(TREE_WGS_x_corrected = as.numeric(TREE_WGS_x_corrected),\n         TREE_WGS_y_corrected = as.numeric(TREE_WGS_y_corrected),\n         Comment = as.character(Comment))\n\n#TREE INFO\nsample <- raw_sample %>%\n  # format data\n  mutate(DBH_SUM_TREE = sapply(strsplit(raw_sample$DBH_single, '/'), function(x) sum(as.numeric(x)))) %>% \n  filter(SPECIES != \"SA\", is.na(EXCLUDE)) %>%\n  rename(SPECIES_TREE = SPECIES) %>% \n  unite(SAMPLE_CODE_LONG, c(DATE, METEO_ID, SPECIES_TREE), sep= \"_\", remove = FALSE) %>%\n  mutate(SAMPLE_CODE_LONG = stringr::str_replace_all(SAMPLE_CODE_LONG, \"[-]\", \"_\")) %>% \n  unite(SAMPLE_CODE, c(METEO_ID, SPECIES_TREE), sep=\"_\", remove=FALSE) %>% \n  separate(CROWN_EXPOSITION_ASPECT1, c(\"CROWN_EXPOSITION_ASPECT1_TRUE\",\"CROWN_EXPOSITION_ASPECT1_MAG\"), sep =\"/\") %>% \n  separate(CROWN_EXPOSITION_ASPECT2, c(\"CROWN_EXPOSITION_ASPECT2_TRUE\",\"CROWN_EXPOSITION_ASPECT2_MAG\"), sep=\"/\") %>%\n  separate(SLOPE_ASPECT1, c(\"SLOPE_ASPECT1_TRUE\",\"SLOPE_ASPECT1_MAG\"), sep =\"/\") %>%\n  separate(SLOPE_ASPECT2, c(\"SLOPE_ASPECT2_TRUE\",\"SLOPE_ASPECT2_MAG\"), sep =\"/\") %>%\n  mutate(COORDINATE_ID = as.numeric(COORDINATE_ID),\n         CROWN_EXPOSITION_ASPECT1_TRUE = as.numeric(CROWN_EXPOSITION_ASPECT1_TRUE), #it is safer to mutate instead of convert during the separation\n         CROWN_EXPOSITION_ASPECT2_TRUE = as.numeric(CROWN_EXPOSITION_ASPECT2_TRUE),\n         CROWN_EXPOSITION_ASPECT1_MAG = as.numeric(CROWN_EXPOSITION_ASPECT1_MAG),\n         CROWN_EXPOSITION_ASPECT2_MAG = as.numeric(CROWN_EXPOSITION_ASPECT2_MAG),\n         SLOPE_ASPECT1_TRUE = as.numeric(SLOPE_ASPECT1_TRUE),\n         SLOPE_ASPECT2_TRUE = as.numeric(SLOPE_ASPECT2_TRUE),\n         SLOPE_ASPECT1_MAG = as.numeric(SLOPE_ASPECT1_MAG),\n         SLOPE_ASPECT2_MAG = as.numeric(SLOPE_ASPECT2_MAG),\n         SLOPE_INCLINATION = as.integer(SLOPE_INCLINATION),\n         SLOPE_INCLINATION2 = as.integer(SLOPE_INCLINATION2),\n         HOLE_DEPTH_1 = as.numeric(HOLE_DEPTH_1),\n         HOLE_DEPTH_2 = as.numeric(HOLE_DEPTH_2),\n         HOLE_DEPTH_3 = as.numeric(HOLE_DEPTH_3),\n         CORE_DEPTH_1 = as.numeric(CORE_DEPTH_1),\n         CORE_DEPTH_2 = as.numeric(CORE_DEPTH_2),\n         CORE_DEPTH_3 = as.numeric(CORE_DEPTH_3),\n         TREE_HEIGHT = as.numeric(TREE_HEIGHT),\n         DBH_single = as.numeric(DBH_single),\n         EDGE_DIST_IMPUTED = case_when(EDGE_DIST == \"x\" ~\"imputed\",\n                                                  EDGE_DIST == \"∞\" ~\"imputed\",\n                                                  is.na(EDGE_DIST) ~\"imputed\",\n                                                  TRUE ~\"original\"),\n         EDGE_DIST = as.numeric(case_when(EDGE_DIST == \"x\" ~\"-5\",\n                                       EDGE_DIST == \"∞\" ~\"50\",\n                                       is.na(EDGE_DIST) ~\"-5\",\n                                       TRUE ~EDGE_DIST)),\n         RELIEF = case_when(RELIEF == \"1\"~ \"flat\",\n                            RELIEF == \"2\"~ \"crest or upper slope\",\n                            RELIEF == \"3\"~ \"midslope\",\n                            RELIEF == \"4\"~ \"slope base or trough\",\n                            RELIEF == \"5\"~ \"not determined\",\n                            TRUE ~ as.character(RELIEF))) %>% \n  mutate(across(c(RELIEF, KRAFT_CLASS), as.factor)) %>%\n  filter(DATE != \"Kontrolle\", !is.na(COORDINATE_ID)) %>% # TO DO: remove data check line from original data\n  \n  # impute missing or wrong measurements at individual sites\n  mutate(DBH_SUM_TREE = case_when(SAMPLE_CODE_LONG == \"20_04_23_CEC_TC\" ~ 29,\n         TRUE ~ DBH_SUM_TREE)) %>%\n  # correct slope inclination # TO DO: Move this to topography\n  mutate(SLOPE_INCLINATION = case_when(SAMPLE_CODE==\"LOL_LD\" ~ SLOPE_INCLINATION2,\n                                       SAMPLE_CODE==\"GON_TC\" ~ SLOPE_INCLINATION2,\n                                       TRUE ~ SLOPE_INCLINATION)) %>%\n  # correct slope aspect # TO DO: Move this to topography\n  mutate(SLOPE_ASPECT1_MAG = case_when(SAMPLE_CODE ==\"LCN_FS\" ~ 110,\n                                       TRUE ~SLOPE_ASPECT1_MAG)) %>% \n  # transform slope to degrees and calculate slope index # TO DO: Move this to topography\n  mutate(SLOPE_INCLINATION_DEG = atan(SLOPE_INCLINATION/100)*(180/pi),\n         SLOPE_INCLINATION_INDEX = 1-((SLOPE_INCLINATION_DEG)/90)) %>% # TO DO: Move this to topography\n  # temporarily correct HOLE_DEPTH as long as it's a proxy for water capacity\n  rowwise() %>%\n  mutate(HOLE_DEPTH_MAX = pmax(HOLE_DEPTH_1, HOLE_DEPTH_2, HOLE_DEPTH_3, na.rm=TRUE))\n\n#COMPETITION INFO\nsample_comp <- raw_sample_comp %>%\n  rename(SAMPLE_CODE_LONG = SAMPLE_CODE) %>% \n  mutate(SPECIES = case_when(SPECIES == \"LD\" ~ \"Larix decidua\",\n                             SPECIES == \"PA\" ~ \"Picea abies\",\n                             SPECIES == \"TC\" ~ \"Tilia cordata\",\n                             SPECIES == \"FS\" ~ \"Fagus sylvatica\",\n                             SPECIES == \"PV\" ~ \"Prunus avium\",\n                             SPECIES == \"RP\" ~ \"Robinia pseudoacacia\",\n                             TRUE ~ as.character(SPECIES)),\n         SAMPLE_CODE_LONG = stringr::str_replace_all(SAMPLE_CODE_LONG, \"[-]\", \"_\"),\n         SAMPLE_CODE = str_sub(SAMPLE_CODE_LONG, 10),\n         DBH_SUM_COMP = sapply(strsplit(raw_sample_comp$DBH_single, '/'), function(x) sum(as.numeric(x))),\n         DISTANCE = as.numeric(DISTANCE),\n         HEIGHT = as.numeric(HEIGHT)) %>% \n  filter(SPECIES != \"Corylus avellana\") %>%\n  rename(SPECIES_COMP = SPECIES) %>%\n  right_join(sample %>% #right join because trees without competition should be added as well\n               dplyr::select(SAMPLE_CODE_LONG, METEO_ID, SPECIES_TREE, LAND_USE, KRAFT_CLASS, SOCIAL_SITUATION, CROWN_EXPOSITION_CLASS, TREE_HEIGHT,  DBH_SUM_TREE) %>%\n               filter(SAMPLE_CODE_LONG != \"Kontrolle-x-x\"),\n             by = \"SAMPLE_CODE_LONG\") %>% \n  mutate(RELATIVE_CROWN_DISTANCE=as.numeric(case_when(is.na(RELATIVE_CROWN_DISTANCE) ~\"7\",\n                                                      RELATIVE_CROWN_DISTANCE==\"x\" ~\"6\",\n                                                      TRUE~ as.character(RELATIVE_CROWN_DISTANCE))))\n\n#SOIL INFO\nsample_soil <- raw_sample_soil %>%\n  mutate(SAMPLE_CODE_LONG = stringr::str_replace_all(SAMPLE_CODE, \"[-]\", \"_\"),\n         SAMPLE_CODE = str_sub(SAMPLE_CODE_LONG, 10),\n         SAMPLE_ID = case_when(DEPTH != \"extra\" ~ paste0(SAMPLE_CODE, sep=\"_\", DEPTH),\n                               DEPTH == \"extra\" ~ paste0(SAMPLE_CODE, sep=\"_\", DEPTH_EXTRA),\n                               TRUE ~ \"other\"),\n         DEPTH_ASSIGNED = case_when(is.na(DEPTH_ASSIGNED) ~ DEPTH,\n                                    TRUE ~ DEPTH_ASSIGNED),\n         POOLED_SAMPLE = POOLED_SAMPLE %>%\n           str_replace(\".{1,9}\", \"\") %>%\n           str_replace_all(\"-\", \"_\")) %>% \n  filter(!SAMPLE_CODE_LONG %like% \"SA\", !SAMPLE_CODE_LONG %like% \"RP\") %>%\n  bind_rows(filter(., !is.na(POOLED_SAMPLE)) %>%\n              mutate(SAMPLE_CODE = POOLED_SAMPLE,\n                     POOLED_SAMPLE = paste0(POOLED_SAMPLE, \"_COPY\")))\n\n#SAMPLE DATA\nsample_data <- sample %>% \n  left_join(sample_coord, by = \"COORDINATE_ID\") %>%\n  left_join(sample_coord_corrected %>% select(METEO_ID, SPECIES_TREE, TREE_WGS_y_corrected, TREE_WGS_x_corrected), by = c(\"METEO_ID\", \"SPECIES_TREE\")) %>%\n  left_join(station_meteoswiss %>% select(nat_abbr, siteId), by=c(\"METEO_ID\"=\"nat_abbr\"))\n```\n\n```{r save-output}\nsaveRDS(sample_data %>% ungroup(), paste0(path_own_data, \"/sample_data.rds\"))\nsaveRDS(sample_comp %>% ungroup(), paste0(path_own_data, \"/sample_competition.rds\"))\n```\n\n```{r create-soil-labels}\nmeta <- read.xlsx(\"C:/Users/iostovary/OneDrive - ETH Zurich/zivi_soil/sampling_data_230815.xlsm\", sheet = \"spn_soil_cores\") %>%\n   mutate(SAMPLE_CODE = str_sub(stringr::str_replace_all(SAMPLE_CODE, \"[-]\", \"_\"), 10),\n          SOIL_SAMPLE_ID = case_when(DEPTH != \"extra\" ~ paste0(SAMPLE_CODE, sep=\"_\", CORE_NO, sep=\"_\", stringr::str_replace_all(DEPTH, \"[-]\", \"_\")),\n                                     DEPTH == \"extra\" ~ paste0(SAMPLE_CODE, sep=\"_\", CORE_NO, sep=\"_\", stringr::str_replace_all(DEPTH_EXTRA, \"[-]\", \"_\")),\n                                     TRUE ~ \"other\"),\n          DEPTH = case_when(DEPTH ==\"extra\" ~ DEPTH_EXTRA,\n                            TRUE ~ DEPTH),\n          DEPTH_LABEL = case_when(is.na(DEPTH_ASSIGNED) ~ DEPTH,\n                                     TRUE ~ DEPTH_ASSIGNED),\n          SAMPLE_CORE = paste0(SAMPLE_CODE, \"_\", CORE_NO)) %>%\n  separate(SAMPLE_CODE, into = c(\"METEO_ID\",\"SPECIES_SHORT\"), remove = FALSE) %>% \n  separate(DEPTH, into=c(\"DEPTH_FROM\", \"DEPTH_TO\"), sep=\"-\", remove=FALSE) %>%\n  mutate(DEPTH_FROM = as.numeric(DEPTH_FROM),\n         DEPTH_TO = as.numeric(DEPTH_TO)) %>%\n  mutate(DEPTH_FROM = case_when(SOIL_SAMPLE_ID == \"LIN_FS_1_999\" ~ 5,\n                                TRUE ~ DEPTH_FROM),\n         DEPTH_TO = case_when(SOIL_SAMPLE_ID == \"LIN_FS_1_999\" ~ 10,\n                              TRUE ~ DEPTH_TO)) %>%\n  select(SOIL_SAMPLE_ID, SAMPLE_CODE, METEO_ID, SPECIES_SHORT, DEPTH_LABEL, DEPTH_FROM, DEPTH_TO, SAMPLE_CORE) %>%\n  unique()\n\nsaveRDS(meta %>% ungroup(), paste0(path_own_data, \"/soil_lab/soil_labels.rds\"))\n```\n\n\n## Climate\n\n### Data extraction\n\nMinimum, maximum and mean temperature as well as precipitation were\nextracted for each individual tree from 1970 to 2023 from the DAYMET\nnetCDF files \\[citation missing\\].\n\n```{r}\nsample_data <- readRDS(paste0(path_own_data, \"/sample_data.rds\"))\n```\n\n```{r}\nlibrary(terra)\ntree_coordinate_individual <- sample_data %>% filter(SPECIES_TREE %in% species_list) %>% \n  dplyr::select(SAMPLE_CODE, TREE_WGS_x_corrected, TREE_WGS_y_corrected) %>%\n  unique() %>%\n  mutate(TREE_WGS_x_corrected=as.numeric(TREE_WGS_x_corrected),\n         TREE_WGS_y_corrected=as.numeric(TREE_WGS_y_corrected)) %>%\n  rename(X = TREE_WGS_x_corrected,\n         Y = TREE_WGS_y_corrected) %>%\n  ungroup() %>%\n  mutate(COORD_ID = row_number())\n\ntree_coordinate_WGS <- terra::vect(tree_coordinate_individual, geom=c(\"Y\", \"X\"),\n                        #crs=\"+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs\",\n                        crs=\"EPSG:4326\", # WGS84\n                        keepgeom=TRUE)\n\ntree_coordinate_ <- terra::project(tree_coordinate_WGS,\"EPSG:2056\") # LV95\n\ntree_coordinate_LV95 <- terra::as.data.frame(tree_coordinate_, geom=\"XY\") %>%\n  rename(LV95_TREE_x = x,\n         LV95_TREE_y = y) %>%\n  dplyr::select(LV95_TREE_x, LV95_TREE_y, COORD_ID) %>%\n  mutate_all(as.integer)\n\nsaveRDS(tree_coordinate_individual, paste0(path_own_data, \"/tree_coordinate_individual.rds\"))\nwrite.table(tree_coordinate_LV95, paste0(path_own_data,\"/coord.list\"), row.names = FALSE, col.names = FALSE)\n\ntree_coordinate_center <- sample_data %>%\n  select(METEO_ID, TREE_WGS_x, TREE_WGS_y) %>%\n  mutate(TREE_WGS_x=as.numeric(TREE_WGS_x),\n         TREE_WGS_y=as.numeric(TREE_WGS_y)) %>%\n  group_by(METEO_ID) %>%\n  summarise(X = mean(TREE_WGS_x),\n            Y = mean(TREE_WGS_y)) %>%\n  mutate(COORD_ID = 1:n()) %>%\n  ungroup()\n\nsaveRDS(tree_coordinate_center, paste0(path_own_data, \"/tree_coordinate_center.rds\"))\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":8,"fig-height":4,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":false,"echo":false,"output":"html_document","warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"wrap","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","highlight-style":"espresso","toc":true,"toc-depth":3,"include-in-header":{"text":"<script type=\"text/javascript\" src=\"C:/Users/iostovary/Documents/Data/00_helpers/zoom.js\"></script>"},"output-file":"0_raw_data.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.549","bibliography":["C:/Users/iostovary/Documents/Data/references.bib"],"csl":"C:/Users/iostovary/Documents/Data/citation_style_global-ecology-and-biogeography_mod_ostovary.csl","editor":"visual","page-layout":"full","code-summary":"Show the code","theme":"minty","code-folding":"hide","grid":{"body-width":"1100px"},"toc-location":"right","toc-float":{"collapsed":false,"number-sections":true},"editor_options":{"chunk_output_type":"inline"}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}