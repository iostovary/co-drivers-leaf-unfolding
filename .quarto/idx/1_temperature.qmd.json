{"title":"Temperature","markdown":{"yaml":{"editor":{"markdown":{"wrap":72}},"editor_options":{"chunk_output_type":"inline"},"execute":{"freeze":true}},"headingText":"Temperature","containsRefs":false,"markdown":"\n\n\n```{r load-libraries}\nlocation <- paste0(getwd())\nsource(paste0(\"../00_helpers/setup.R\")) #common libraries and custom functions\nsource(paste0(\"../00_helpers/species_and_phases.R\"))\nsample_data <- readRDS(paste0(path_own_data, \"/sample_data.rds\"))\nphenology <- readRDS(paste0(path_own_data, \"/input_phenology.rds\"))\nphenology_cut <- readRDS(paste0(path_own_data, \"/input_phenology_cut.rds\"))\n```\n\n```{r prepare-temperature-input, eval=FALSE}\ntree_coordinate_individual <- readRDS(paste0(path_own_data, \"/tree_coordinate_individual.rds\"))\n\ndaymet_daily_tree <- read.csv(paste0(location, \"DAYMET_switzerland/wsl-daymet/daymetDaily_179sites.csv\")) %>%\n  separate(siteId, into=c(\"COORD_ID\", \"trash\"), sep =\"\\\\.\") %>%\n  dplyr::select(-trash) %>%\n  mutate(COORD_ID = as.integer(COORD_ID)) %>% \n  left_join(tree_coordinate_individual %>% dplyr::select(-X,-Y), by=\"COORD_ID\") %>% \n  pivot_wider(names_from = \"var\", values_from = \"dailyVal\") %>%\n  dplyr::select(- lat, -lon, -COORD_ID) %>%\n  separate(date, c(\"year\",\"month\",\"day\"), remove=FALSE) %>%\n  mutate(year= as.numeric(year),\n         date = as_date(date),\n         DATE_NUMBER = yday(date)) %>%\n  separate(SAMPLE_CODE, into=c(\"METEO_ID\", \"SPECIES_SHORT\"), remove=FALSE) %>% \n  semi_join(phenology_cut, by=c(\"METEO_ID\"=\"nat_abbr\",\"year\"))\n\nsaveRDS(daymet_daily_tree %>% ungroup(), paste0(path_own_data, \"/raw_daymet_daily_tree.rds\"))\n\ngdd_input <- daymet_daily_tree %>%\n  left_join(phenology %>% dplyr::select(SAMPLE_CODE, doy, year, PHASE),\n            by=c(\"SAMPLE_CODE\", \"year\")) %>%\n  semi_join(phenology_cut, by=c(\"SAMPLE_CODE\",\"year\",\"PHASE\")) %>%\n  rename(tave=tmea)\n\nsaveRDS(gdd_input %>% ungroup(), paste0(path_own_data, \"/raw_gdd_input.rds\"))\n```\n\n```{r load-temperature-data}\ndaymet_daily_tree <- readRDS(paste0(path_own_data, \"/raw_daymet_daily_tree.rds\"))\ndaymet_monthly_tree_avg <- readRDS(paste0(path_own_data, \"/daymet_monthly_tree_avg.rds\"))\ngdd_input <- readRDS(paste0(path_own_data, \"/raw_gdd_input.rds\")) %>%\n  select(-METEO_ID, -SPECIES_SHORT, -date, -month, -day)\n```\n\n## Data collection\n\nWeather data was extracted with Tom Hands python Script from the unpublished DAYMET files provided by Dirk Schmatz from WSL. The coordinates used for\nextraction were the individual tree coordinates.\n\n```{r raw-climate-daymet-prcp, fig.cap=\"Mean modelled monthly precipitation sum per SPN site.\"}\nggplot(daymet_monthly_tree_avg %>%\n         group_by(SAMPLE_CODE, month) %>%\n         summarize(prcp = mean(prcp)))+\n  geom_line(aes(x=month, y=prcp, group=SAMPLE_CODE), color=\"blue\")+\n  labs(x = \"Year\",\n       y = \"Precipitation (mm)\")+\n  theme_report(angle = 90)\n```\n\n```{r raw-climate-daymet-temp, fig.cap=\"Modelled average monthly temperature per SPN site.\"}\nggplot(daymet_monthly_tree_avg %>%\n         group_by(SAMPLE_CODE, month) %>%\n         summarize(tave = mean(tave),\n                   tmin = mean(tmin)))+\n  geom_line(aes(x=month, y=tave, group=SAMPLE_CODE), color=\"red\")+\n  labs(x = \"Year\",\n       y = \"Average temperature (°C)\")+\n  theme_report(angle = 90)\n```\n\n## Growing degree days\n\nGrowing degree days were calculated with (1) the classical approach that\nuses daily mean temperature and (2) an approach based on the fact that\ndaytime temperature is more relevant to phenological development than\nnight time temperature [@citationneeded]. Though, @chen2020 pointed out,\nthat the response to daytime temperature could be due to drought stress.\nLeaf senescence is more likely to advance in drought intolerant species\nunder dry and consequently warm conditions [@chen2020].\n\n$GDD=\\sum_{Jan \\ 1st}^{\\overline{doy}}(T_i - T{base}) \\ \\ if \\ \\ T_{measured} \\ > \\ T_{base}$\n\n$GDD = \\sum_{Jan \\ 1st}^{5 \\ percentile \\ of \\ earliest \\ doy \\ per \\ site} (T_i - T_{base}) \\ \\ if \\ \\ T_{measured} > T_{base}$\n\nI used the base temperature 3 and 5 ° C with average and daytime temperature.\n\n## Chilling degree days\n\n@sarvas1974 found that ontogenetic development occurs between -3 and +5°\nC. He concluded, that the completion of endodormancy in finish forest\ntrees was shortest at +3.5° C.\n\nChilling degree days were calculated with the formula:\n\n$CDD = \\sum_{i=1}^{n} CD_i$\n\n$CD_i = { T_b - T_{\\text{ave}} \\ \\ if \\ \\ T_{\\text{ave}} < T_b, \\\\ 0 \\ \\ if \\ \\ T > T_{\\text{ave}}}$\n\n@wang2023, @wu2022\n\nWhere CD is the extent to which $T_{ave}$ (daily mean temperature) is below\n$T_b$ (temperature base) on day $i$.\n\n```{r calculate-daily-gdd-cdd, include=TRUE, echo=TRUE, filename=\"Settings and calculation of daily GDD and CDD.\"}\nGDD_BASE5 <- 5\nGDD_BASE3 <- 3\n\nCDD_BASE5 <- 5\nCDD_BASE8 <- 8\n\nGDD_INPUT <-  gdd_input %>% \n  group_by(year, SAMPLE_CODE, PHASE) %>% \n  nest() %>%\n  #filter(year < 2000) %>% \n  mutate(GDD = map(data, ~ mutate(\n    # Calculate daily temperature value according to base\n    .x, GDD_AVE3 = ((tmax + tmin) / 2) - GDD_BASE3,\n    .x, GDD_AVE5 = ((tmax + tmin) / 2) - GDD_BASE5,\n    .x, GDD_MAX3 = tmax - GDD_BASE3,\n    .x, GDD_MAX5 = tmax - GDD_BASE5,\n\n    .x, CDD_AVE5 = abs(CDD_BASE5 - tave),\n    .x, CDD_AVE8 = abs(CDD_BASE8 - tave),\n    \n    .x, CDD_AVE_CAP5 = if_else(CDD_AVE5 > 10, 10, CDD_AVE5),\n    .x, CDD_AVE_CAP8 = if_else(CDD_AVE8 > 13, 13, CDD_AVE8),\n    .x, CDD_AVE_CAP8.0 = if_else(CDD_AVE8 > 8, 8, CDD_AVE8))))\n```\n\n```{r calculate-accumulation-end-percentile, include=TRUE, echo=TRUE, filename=\"Regression to calculate site specific accumulation end date according to the earliest days of year.\"}\nreg_input <- sample_data %>%\n  select(SAMPLE_CODE, TREE_ELEVATION) %>%\n  left_join(phenology %>%\n              select(SAMPLE_CODE, year, doy, PHASE) %>%\n              ungroup(), by=c(\"SAMPLE_CODE\")) %>%\n  semi_join(phenology_cut %>%\n              select(-PHASE) %>% unite(\"SAMPLE_CODE\", c(\"nat_abbr\",\"SPECIES_SHORT\"), sep=\"_\"),\n            by=c(\"SAMPLE_CODE\",\"year\", \"doy\")) %>% \n  mutate(TREE_ELEVATION = round(TREE_ELEVATION,2))\n\nGDD_END_QUANT <- reg_input %>% \n  group_by(SAMPLE_CODE) %>%\n  nest() %>%\n  # determine end of year\n  mutate(GDD_END_QUANT = map(data, ~ summarize(\n    .x, GDD_END_QUANT = quantile(doy, 0.05)))) %>%\n  unnest(GDD_END_QUANT)\n```\n\n```{r calculate-accumulation-end-doy, include=TRUE, echo=TRUE, filename=\"Rename the day of year as the end of accumulation.\"}\nGDD_END_DOY <- reg_input %>%\n  mutate(GDD_END_DOY = doy) %>%\n  ungroup()\n```\n\n```{r calculate-accumulation-end-mean, include=TRUE, echo=TRUE, filename=\"Calculate the mean day of year per site.\"}\nGDD_END_MEAN <- reg_input %>%\n  group_by(SAMPLE_CODE) %>%\n  nest() %>%\n  mutate(GDD_END_MEAN = map(data, ~round(mean(.x$doy),0))) %>% \n  select(-data) %>%\n  unnest(cols=c(SAMPLE_CODE, GDD_END_MEAN)) %>% \n  ungroup()\n```\n\n```{r fig-gdd-end, fig.width=16, fig.height=8, fig.cap=\"Estimated end dates of temperature accumulation (coloured) and actual day of year (grey).\"}\nggplot()+\n  geom_point(data=phenology_cut %>% filter(PHASE %like% \"unfold\") %>% rename(METEO_ID = nat_abbr), aes(x=METEO_ID, y=doy), colour=\"grey\", shape=21) +\n  geom_point(data=GDD_END_QUANT %>% separate(SAMPLE_CODE, c(\"METEO_ID\", \"SPECIES_SHORT\"), sep=\"_\", remove=FALSE), aes(x=METEO_ID, y=GDD_END_QUANT, colour=\"GDD_END_QUANT\"), size=2)+\n  geom_point(data=GDD_END_MEAN %>% separate(SAMPLE_CODE, c(\"METEO_ID\", \"SPECIES_SHORT\"), sep=\"_\", remove=FALSE), aes(x=METEO_ID, y=GDD_END_MEAN, colour=\"GDD_END_MEAN\"), size=2)+\n  xlab(\"SPN Station\")+\n  ylab(\"End of Accumulation / Day of Year\")+\n  facet_wrap(~SPECIES_SHORT, scales=\"fixed\")+\n  theme_report(angle=90, legend.position=\"top\")\n```\n\n```{r calculate-sums, include=TRUE, echo=TRUE, filename=\"Calculate growing and chilling degree days.\"}\nTEMPERATURE <- GDD_INPUT %>%\n  # join accumulation ends\n  left_join(GDD_END_QUANT %>% select(SAMPLE_CODE, GDD_END_QUANT), by = \"SAMPLE_CODE\") %>%\n  left_join(GDD_END_MEAN %>% select(SAMPLE_CODE, GDD_END_MEAN), by = \"SAMPLE_CODE\") %>%\n  left_join(GDD_END_DOY %>% select(SAMPLE_CODE, GDD_END_DOY, year), by = c(\"SAMPLE_CODE\", \"year\")) %>%\n  \n  # calculate GDD sum\n  mutate(GDD_OUT = map(GDD, ~ summarize(\n    .x,\n    \n    # calculate conservative GDD\n    GDD_SUM_QUANTAVE3 = sum(if_else(DATE_NUMBER <= GDD_END_QUANT & tave > GDD_BASE3, GDD_AVE3, 0)),\n    GDD_SUM_QUANTAVE5 = sum(if_else(DATE_NUMBER <= GDD_END_QUANT & tave > GDD_BASE5, GDD_AVE5, 0)),\n    GDD_SUM_QUANTMAX3 = sum(if_else(DATE_NUMBER <= GDD_END_QUANT & tmax > GDD_BASE3, GDD_MAX3, 0)),\n    GDD_SUM_QUANTMAX5 = sum(if_else(DATE_NUMBER <= GDD_END_QUANT & tmax > GDD_BASE5, GDD_MAX5, 0)),\n    \n    # calculate mainstream GDD\n    GDD_SUM_MEANAVE3 = sum(if_else(DATE_NUMBER <= GDD_END_MEAN & tave > GDD_BASE3, GDD_AVE3, 0)),\n    GDD_SUM_MEANAVE5 = sum(if_else(DATE_NUMBER <= GDD_END_MEAN & tave > GDD_BASE5, GDD_AVE5, 0)),\n    GDD_SUM_MEANMAX3 = sum(if_else(DATE_NUMBER <= GDD_END_MEAN & tmax > GDD_BASE3, GDD_MAX3, 0)),\n    GDD_SUM_MEANMAX5 = sum(if_else(DATE_NUMBER <= GDD_END_MEAN & tmax > GDD_BASE5, GDD_MAX5, 0))\n    \n  ))) %>% \n\n  # calculate CDD sum\n  mutate(CDD_OUT = map(GDD, ~ summarize(\n         .x,\n         \n         # from 15.12. of the previous year to 31.12. of the previous year\n         CDD_SUM_AVE5_pre = sum(if_else(DATE_NUMBER > 350 & tave < CDD_BASE5, CDD_AVE_CAP5, 0)),\n         CDD_SUM_AVE8_pre = sum(if_else(DATE_NUMBER > 350 & tave < CDD_BASE8, CDD_AVE_CAP8, 0)),\n         CDD_SUM_AVE8.0_pre = sum(if_else(DATE_NUMBER > 319 & tave < CDD_BASE8, CDD_AVE_CAP8.0, 0)), # 15. of November\n\n         \n         # from 1.1. of current year to accumulation end\n         CDD_SUM_MEANAVE5_cur = sum(if_else(DATE_NUMBER < GDD_END_MEAN & tave < CDD_BASE5, CDD_AVE_CAP5, 0)),\n         CDD_SUM_MEANAVE8_cur = sum(if_else(DATE_NUMBER < GDD_END_MEAN & tave < CDD_BASE8, CDD_AVE_CAP8, 0)),\n\n         CDD_SUM_QUANTAVE5_cur = sum(if_else(DATE_NUMBER < GDD_END_QUANT & tave < CDD_BASE5, CDD_AVE_CAP5, 0)),\n         CDD_SUM_QUANTAVE8_cur = sum(if_else(DATE_NUMBER < GDD_END_QUANT & tave < CDD_BASE8, CDD_AVE_CAP8, 0)),\n         CDD_SUM_QUANTAVE8.0_cur = sum(if_else(DATE_NUMBER < GDD_END_QUANT & tave < CDD_BASE8, CDD_AVE_CAP8.0, 0)) # test capped sum at 0 degrees\n         ))) %>%\n  mutate(doy = map(data, ~select(.x, doy) %>% unique())) %>% \n  select(-data, -GDD) %>%\n  unnest(cols = c(year, SAMPLE_CODE, PHASE, GDD_OUT, CDD_OUT, doy)) %>% ungroup() %>%\n  \n  # sum CDD of previous year with current year\n  mutate(CDD_SUM_AVE5_pre = lag(CDD_SUM_AVE5_pre, n = 1),\n         CDD_SUM_AVE8_pre = lag(CDD_SUM_AVE5_pre, n = 1),\n         CDD_SUM_MEANAVE5 = CDD_SUM_AVE5_pre + CDD_SUM_MEANAVE5_cur,\n         CDD_SUM_MEANAVE8 = CDD_SUM_AVE5_pre + CDD_SUM_MEANAVE8_cur,\n         CDD_SUM_QUANTAVE5 = CDD_SUM_AVE5_pre + CDD_SUM_QUANTAVE5_cur,\n         CDD_SUM_QUANTAVE8 = CDD_SUM_AVE5_pre + CDD_SUM_QUANTAVE8_cur,\n         CDD_SUM_QUANTAVE8.0 = CDD_SUM_AVE8.0_pre + CDD_SUM_QUANTAVE8.0_cur)\n```\n\n## Distributions and correlations\n\n```{r pairs, warning=FALSE, fig.height=15, fig.retina=2, fig.cap = \"Pairs plot of temperature and degree day sums for leaf unfolding at all sampled SPN sites. Degree day parameters represent a single value of accumulated temperature from the respective starting day until the respective day of year.\"}\npairs_gdd <- TEMPERATURE %>% ungroup() %>% select(is.numeric, -contains(\"END\"), -contains(\"START\"), -doy)\n  \nggpairs(pairs_gdd, showStrips=TRUE, progress=FALSE)+\n  theme_report(angle=90)\n```\n\n```{r save-output}\nsaveRDS(TEMPERATURE %>% select(SAMPLE_CODE, PHASE, doy, year, GDD_SUM_QUANTAVE3, GDD_SUM_QUANTAVE5, GDD_SUM_QUANTMAX3, GDD_SUM_QUANTMAX5, GDD_SUM_MEANAVE3, GDD_SUM_MEANAVE5, GDD_SUM_MEANMAX3, GDD_SUM_MEANMAX5,\n                               #GDD_SUM_DOYAVE3, GDD_SUM_DOYAVE5, GDD_SUM_DOYMAX3, GDD_SUM_DOYMAX5,\n                               CDD_SUM_MEANAVE5, CDD_SUM_MEANAVE8, CDD_SUM_QUANTAVE5, CDD_SUM_QUANTAVE8, CDD_SUM_QUANTAVE8.0) %>% ungroup(), paste0(path_own_data, \"/input_temperature_unfolding.rds\"))\n```","srcMarkdownNoYaml":"\n\n# Temperature\n\n```{r load-libraries}\nlocation <- paste0(getwd())\nsource(paste0(\"../00_helpers/setup.R\")) #common libraries and custom functions\nsource(paste0(\"../00_helpers/species_and_phases.R\"))\nsample_data <- readRDS(paste0(path_own_data, \"/sample_data.rds\"))\nphenology <- readRDS(paste0(path_own_data, \"/input_phenology.rds\"))\nphenology_cut <- readRDS(paste0(path_own_data, \"/input_phenology_cut.rds\"))\n```\n\n```{r prepare-temperature-input, eval=FALSE}\ntree_coordinate_individual <- readRDS(paste0(path_own_data, \"/tree_coordinate_individual.rds\"))\n\ndaymet_daily_tree <- read.csv(paste0(location, \"DAYMET_switzerland/wsl-daymet/daymetDaily_179sites.csv\")) %>%\n  separate(siteId, into=c(\"COORD_ID\", \"trash\"), sep =\"\\\\.\") %>%\n  dplyr::select(-trash) %>%\n  mutate(COORD_ID = as.integer(COORD_ID)) %>% \n  left_join(tree_coordinate_individual %>% dplyr::select(-X,-Y), by=\"COORD_ID\") %>% \n  pivot_wider(names_from = \"var\", values_from = \"dailyVal\") %>%\n  dplyr::select(- lat, -lon, -COORD_ID) %>%\n  separate(date, c(\"year\",\"month\",\"day\"), remove=FALSE) %>%\n  mutate(year= as.numeric(year),\n         date = as_date(date),\n         DATE_NUMBER = yday(date)) %>%\n  separate(SAMPLE_CODE, into=c(\"METEO_ID\", \"SPECIES_SHORT\"), remove=FALSE) %>% \n  semi_join(phenology_cut, by=c(\"METEO_ID\"=\"nat_abbr\",\"year\"))\n\nsaveRDS(daymet_daily_tree %>% ungroup(), paste0(path_own_data, \"/raw_daymet_daily_tree.rds\"))\n\ngdd_input <- daymet_daily_tree %>%\n  left_join(phenology %>% dplyr::select(SAMPLE_CODE, doy, year, PHASE),\n            by=c(\"SAMPLE_CODE\", \"year\")) %>%\n  semi_join(phenology_cut, by=c(\"SAMPLE_CODE\",\"year\",\"PHASE\")) %>%\n  rename(tave=tmea)\n\nsaveRDS(gdd_input %>% ungroup(), paste0(path_own_data, \"/raw_gdd_input.rds\"))\n```\n\n```{r load-temperature-data}\ndaymet_daily_tree <- readRDS(paste0(path_own_data, \"/raw_daymet_daily_tree.rds\"))\ndaymet_monthly_tree_avg <- readRDS(paste0(path_own_data, \"/daymet_monthly_tree_avg.rds\"))\ngdd_input <- readRDS(paste0(path_own_data, \"/raw_gdd_input.rds\")) %>%\n  select(-METEO_ID, -SPECIES_SHORT, -date, -month, -day)\n```\n\n## Data collection\n\nWeather data was extracted with Tom Hands python Script from the unpublished DAYMET files provided by Dirk Schmatz from WSL. The coordinates used for\nextraction were the individual tree coordinates.\n\n```{r raw-climate-daymet-prcp, fig.cap=\"Mean modelled monthly precipitation sum per SPN site.\"}\nggplot(daymet_monthly_tree_avg %>%\n         group_by(SAMPLE_CODE, month) %>%\n         summarize(prcp = mean(prcp)))+\n  geom_line(aes(x=month, y=prcp, group=SAMPLE_CODE), color=\"blue\")+\n  labs(x = \"Year\",\n       y = \"Precipitation (mm)\")+\n  theme_report(angle = 90)\n```\n\n```{r raw-climate-daymet-temp, fig.cap=\"Modelled average monthly temperature per SPN site.\"}\nggplot(daymet_monthly_tree_avg %>%\n         group_by(SAMPLE_CODE, month) %>%\n         summarize(tave = mean(tave),\n                   tmin = mean(tmin)))+\n  geom_line(aes(x=month, y=tave, group=SAMPLE_CODE), color=\"red\")+\n  labs(x = \"Year\",\n       y = \"Average temperature (°C)\")+\n  theme_report(angle = 90)\n```\n\n## Growing degree days\n\nGrowing degree days were calculated with (1) the classical approach that\nuses daily mean temperature and (2) an approach based on the fact that\ndaytime temperature is more relevant to phenological development than\nnight time temperature [@citationneeded]. Though, @chen2020 pointed out,\nthat the response to daytime temperature could be due to drought stress.\nLeaf senescence is more likely to advance in drought intolerant species\nunder dry and consequently warm conditions [@chen2020].\n\n$GDD=\\sum_{Jan \\ 1st}^{\\overline{doy}}(T_i - T{base}) \\ \\ if \\ \\ T_{measured} \\ > \\ T_{base}$\n\n$GDD = \\sum_{Jan \\ 1st}^{5 \\ percentile \\ of \\ earliest \\ doy \\ per \\ site} (T_i - T_{base}) \\ \\ if \\ \\ T_{measured} > T_{base}$\n\nI used the base temperature 3 and 5 ° C with average and daytime temperature.\n\n## Chilling degree days\n\n@sarvas1974 found that ontogenetic development occurs between -3 and +5°\nC. He concluded, that the completion of endodormancy in finish forest\ntrees was shortest at +3.5° C.\n\nChilling degree days were calculated with the formula:\n\n$CDD = \\sum_{i=1}^{n} CD_i$\n\n$CD_i = { T_b - T_{\\text{ave}} \\ \\ if \\ \\ T_{\\text{ave}} < T_b, \\\\ 0 \\ \\ if \\ \\ T > T_{\\text{ave}}}$\n\n@wang2023, @wu2022\n\nWhere CD is the extent to which $T_{ave}$ (daily mean temperature) is below\n$T_b$ (temperature base) on day $i$.\n\n```{r calculate-daily-gdd-cdd, include=TRUE, echo=TRUE, filename=\"Settings and calculation of daily GDD and CDD.\"}\nGDD_BASE5 <- 5\nGDD_BASE3 <- 3\n\nCDD_BASE5 <- 5\nCDD_BASE8 <- 8\n\nGDD_INPUT <-  gdd_input %>% \n  group_by(year, SAMPLE_CODE, PHASE) %>% \n  nest() %>%\n  #filter(year < 2000) %>% \n  mutate(GDD = map(data, ~ mutate(\n    # Calculate daily temperature value according to base\n    .x, GDD_AVE3 = ((tmax + tmin) / 2) - GDD_BASE3,\n    .x, GDD_AVE5 = ((tmax + tmin) / 2) - GDD_BASE5,\n    .x, GDD_MAX3 = tmax - GDD_BASE3,\n    .x, GDD_MAX5 = tmax - GDD_BASE5,\n\n    .x, CDD_AVE5 = abs(CDD_BASE5 - tave),\n    .x, CDD_AVE8 = abs(CDD_BASE8 - tave),\n    \n    .x, CDD_AVE_CAP5 = if_else(CDD_AVE5 > 10, 10, CDD_AVE5),\n    .x, CDD_AVE_CAP8 = if_else(CDD_AVE8 > 13, 13, CDD_AVE8),\n    .x, CDD_AVE_CAP8.0 = if_else(CDD_AVE8 > 8, 8, CDD_AVE8))))\n```\n\n```{r calculate-accumulation-end-percentile, include=TRUE, echo=TRUE, filename=\"Regression to calculate site specific accumulation end date according to the earliest days of year.\"}\nreg_input <- sample_data %>%\n  select(SAMPLE_CODE, TREE_ELEVATION) %>%\n  left_join(phenology %>%\n              select(SAMPLE_CODE, year, doy, PHASE) %>%\n              ungroup(), by=c(\"SAMPLE_CODE\")) %>%\n  semi_join(phenology_cut %>%\n              select(-PHASE) %>% unite(\"SAMPLE_CODE\", c(\"nat_abbr\",\"SPECIES_SHORT\"), sep=\"_\"),\n            by=c(\"SAMPLE_CODE\",\"year\", \"doy\")) %>% \n  mutate(TREE_ELEVATION = round(TREE_ELEVATION,2))\n\nGDD_END_QUANT <- reg_input %>% \n  group_by(SAMPLE_CODE) %>%\n  nest() %>%\n  # determine end of year\n  mutate(GDD_END_QUANT = map(data, ~ summarize(\n    .x, GDD_END_QUANT = quantile(doy, 0.05)))) %>%\n  unnest(GDD_END_QUANT)\n```\n\n```{r calculate-accumulation-end-doy, include=TRUE, echo=TRUE, filename=\"Rename the day of year as the end of accumulation.\"}\nGDD_END_DOY <- reg_input %>%\n  mutate(GDD_END_DOY = doy) %>%\n  ungroup()\n```\n\n```{r calculate-accumulation-end-mean, include=TRUE, echo=TRUE, filename=\"Calculate the mean day of year per site.\"}\nGDD_END_MEAN <- reg_input %>%\n  group_by(SAMPLE_CODE) %>%\n  nest() %>%\n  mutate(GDD_END_MEAN = map(data, ~round(mean(.x$doy),0))) %>% \n  select(-data) %>%\n  unnest(cols=c(SAMPLE_CODE, GDD_END_MEAN)) %>% \n  ungroup()\n```\n\n```{r fig-gdd-end, fig.width=16, fig.height=8, fig.cap=\"Estimated end dates of temperature accumulation (coloured) and actual day of year (grey).\"}\nggplot()+\n  geom_point(data=phenology_cut %>% filter(PHASE %like% \"unfold\") %>% rename(METEO_ID = nat_abbr), aes(x=METEO_ID, y=doy), colour=\"grey\", shape=21) +\n  geom_point(data=GDD_END_QUANT %>% separate(SAMPLE_CODE, c(\"METEO_ID\", \"SPECIES_SHORT\"), sep=\"_\", remove=FALSE), aes(x=METEO_ID, y=GDD_END_QUANT, colour=\"GDD_END_QUANT\"), size=2)+\n  geom_point(data=GDD_END_MEAN %>% separate(SAMPLE_CODE, c(\"METEO_ID\", \"SPECIES_SHORT\"), sep=\"_\", remove=FALSE), aes(x=METEO_ID, y=GDD_END_MEAN, colour=\"GDD_END_MEAN\"), size=2)+\n  xlab(\"SPN Station\")+\n  ylab(\"End of Accumulation / Day of Year\")+\n  facet_wrap(~SPECIES_SHORT, scales=\"fixed\")+\n  theme_report(angle=90, legend.position=\"top\")\n```\n\n```{r calculate-sums, include=TRUE, echo=TRUE, filename=\"Calculate growing and chilling degree days.\"}\nTEMPERATURE <- GDD_INPUT %>%\n  # join accumulation ends\n  left_join(GDD_END_QUANT %>% select(SAMPLE_CODE, GDD_END_QUANT), by = \"SAMPLE_CODE\") %>%\n  left_join(GDD_END_MEAN %>% select(SAMPLE_CODE, GDD_END_MEAN), by = \"SAMPLE_CODE\") %>%\n  left_join(GDD_END_DOY %>% select(SAMPLE_CODE, GDD_END_DOY, year), by = c(\"SAMPLE_CODE\", \"year\")) %>%\n  \n  # calculate GDD sum\n  mutate(GDD_OUT = map(GDD, ~ summarize(\n    .x,\n    \n    # calculate conservative GDD\n    GDD_SUM_QUANTAVE3 = sum(if_else(DATE_NUMBER <= GDD_END_QUANT & tave > GDD_BASE3, GDD_AVE3, 0)),\n    GDD_SUM_QUANTAVE5 = sum(if_else(DATE_NUMBER <= GDD_END_QUANT & tave > GDD_BASE5, GDD_AVE5, 0)),\n    GDD_SUM_QUANTMAX3 = sum(if_else(DATE_NUMBER <= GDD_END_QUANT & tmax > GDD_BASE3, GDD_MAX3, 0)),\n    GDD_SUM_QUANTMAX5 = sum(if_else(DATE_NUMBER <= GDD_END_QUANT & tmax > GDD_BASE5, GDD_MAX5, 0)),\n    \n    # calculate mainstream GDD\n    GDD_SUM_MEANAVE3 = sum(if_else(DATE_NUMBER <= GDD_END_MEAN & tave > GDD_BASE3, GDD_AVE3, 0)),\n    GDD_SUM_MEANAVE5 = sum(if_else(DATE_NUMBER <= GDD_END_MEAN & tave > GDD_BASE5, GDD_AVE5, 0)),\n    GDD_SUM_MEANMAX3 = sum(if_else(DATE_NUMBER <= GDD_END_MEAN & tmax > GDD_BASE3, GDD_MAX3, 0)),\n    GDD_SUM_MEANMAX5 = sum(if_else(DATE_NUMBER <= GDD_END_MEAN & tmax > GDD_BASE5, GDD_MAX5, 0))\n    \n  ))) %>% \n\n  # calculate CDD sum\n  mutate(CDD_OUT = map(GDD, ~ summarize(\n         .x,\n         \n         # from 15.12. of the previous year to 31.12. of the previous year\n         CDD_SUM_AVE5_pre = sum(if_else(DATE_NUMBER > 350 & tave < CDD_BASE5, CDD_AVE_CAP5, 0)),\n         CDD_SUM_AVE8_pre = sum(if_else(DATE_NUMBER > 350 & tave < CDD_BASE8, CDD_AVE_CAP8, 0)),\n         CDD_SUM_AVE8.0_pre = sum(if_else(DATE_NUMBER > 319 & tave < CDD_BASE8, CDD_AVE_CAP8.0, 0)), # 15. of November\n\n         \n         # from 1.1. of current year to accumulation end\n         CDD_SUM_MEANAVE5_cur = sum(if_else(DATE_NUMBER < GDD_END_MEAN & tave < CDD_BASE5, CDD_AVE_CAP5, 0)),\n         CDD_SUM_MEANAVE8_cur = sum(if_else(DATE_NUMBER < GDD_END_MEAN & tave < CDD_BASE8, CDD_AVE_CAP8, 0)),\n\n         CDD_SUM_QUANTAVE5_cur = sum(if_else(DATE_NUMBER < GDD_END_QUANT & tave < CDD_BASE5, CDD_AVE_CAP5, 0)),\n         CDD_SUM_QUANTAVE8_cur = sum(if_else(DATE_NUMBER < GDD_END_QUANT & tave < CDD_BASE8, CDD_AVE_CAP8, 0)),\n         CDD_SUM_QUANTAVE8.0_cur = sum(if_else(DATE_NUMBER < GDD_END_QUANT & tave < CDD_BASE8, CDD_AVE_CAP8.0, 0)) # test capped sum at 0 degrees\n         ))) %>%\n  mutate(doy = map(data, ~select(.x, doy) %>% unique())) %>% \n  select(-data, -GDD) %>%\n  unnest(cols = c(year, SAMPLE_CODE, PHASE, GDD_OUT, CDD_OUT, doy)) %>% ungroup() %>%\n  \n  # sum CDD of previous year with current year\n  mutate(CDD_SUM_AVE5_pre = lag(CDD_SUM_AVE5_pre, n = 1),\n         CDD_SUM_AVE8_pre = lag(CDD_SUM_AVE5_pre, n = 1),\n         CDD_SUM_MEANAVE5 = CDD_SUM_AVE5_pre + CDD_SUM_MEANAVE5_cur,\n         CDD_SUM_MEANAVE8 = CDD_SUM_AVE5_pre + CDD_SUM_MEANAVE8_cur,\n         CDD_SUM_QUANTAVE5 = CDD_SUM_AVE5_pre + CDD_SUM_QUANTAVE5_cur,\n         CDD_SUM_QUANTAVE8 = CDD_SUM_AVE5_pre + CDD_SUM_QUANTAVE8_cur,\n         CDD_SUM_QUANTAVE8.0 = CDD_SUM_AVE8.0_pre + CDD_SUM_QUANTAVE8.0_cur)\n```\n\n## Distributions and correlations\n\n```{r pairs, warning=FALSE, fig.height=15, fig.retina=2, fig.cap = \"Pairs plot of temperature and degree day sums for leaf unfolding at all sampled SPN sites. Degree day parameters represent a single value of accumulated temperature from the respective starting day until the respective day of year.\"}\npairs_gdd <- TEMPERATURE %>% ungroup() %>% select(is.numeric, -contains(\"END\"), -contains(\"START\"), -doy)\n  \nggpairs(pairs_gdd, showStrips=TRUE, progress=FALSE)+\n  theme_report(angle=90)\n```\n\n```{r save-output}\nsaveRDS(TEMPERATURE %>% select(SAMPLE_CODE, PHASE, doy, year, GDD_SUM_QUANTAVE3, GDD_SUM_QUANTAVE5, GDD_SUM_QUANTMAX3, GDD_SUM_QUANTMAX5, GDD_SUM_MEANAVE3, GDD_SUM_MEANAVE5, GDD_SUM_MEANMAX3, GDD_SUM_MEANMAX5,\n                               #GDD_SUM_DOYAVE3, GDD_SUM_DOYAVE5, GDD_SUM_DOYMAX3, GDD_SUM_DOYMAX5,\n                               CDD_SUM_MEANAVE5, CDD_SUM_MEANAVE8, CDD_SUM_QUANTAVE5, CDD_SUM_QUANTAVE8, CDD_SUM_QUANTAVE8.0) %>% ungroup(), paste0(path_own_data, \"/input_temperature_unfolding.rds\"))\n```"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":8,"fig-height":4,"fig-format":"retina","fig-dpi":96,"df-print":"paged","error":false,"eval":true,"cache":null,"freeze":true,"echo":false,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"wrap","code-link":false,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","highlight-style":"espresso","toc":true,"toc-depth":3,"include-in-header":{"text":"<script type=\"text/javascript\" src=\"C:/Users/iostovary/Documents/Data/00_helpers/zoom.js\"></script>"},"output-file":"1_temperature.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.549","bibliography":["C:/Users/iostovary/Documents/Data/references.bib"],"csl":"C:/Users/iostovary/Documents/Data/citation_style_global-ecology-and-biogeography_mod_ostovary.csl","editor":{"markdown":{"wrap":72}},"page-layout":"full","code-summary":"Show the code","theme":"minty","code-folding":"hide","grid":{"body-width":"1100px"},"toc-location":"right","toc-float":{"collapsed":false,"number-sections":true},"editor_options":{"chunk_output_type":"inline"}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}